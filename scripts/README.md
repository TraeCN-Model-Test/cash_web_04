# Scripts 目录说明

## 概述

`scripts` 目录包含 CashLog 项目的自动化脚本集合，用于简化开发、测试、数据管理和部署等常见任务。这些脚本旨在提高开发效率，确保系统功能正常运行，并提供便捷的数据操作方式。

## 目录结构

```
scripts/
├── run_integration_tests.sh          # 完整功能集成测试脚本
├── setup_transaction_test_data.sh    # 交易测试数据添加脚本
├── setup_todo_test_data.sh           # 待办事项测试数据添加脚本
├── test_backup_restore_workflow.sh   # 备份恢复功能正常流程测试脚本
├── test_backup_restore_error_cases.sh # 备份恢复功能异常场景测试脚本
└── test_transaction_todo_association.sh # 交易与待办双向关联功能测试脚本
```

## 脚本说明

### 1. run_integration_tests.sh - 完整功能集成测试

**用途**: 全面测试 CashLog 系统的核心功能，包括单元测试、报表服务功能和 CLI 命令。

**主要功能**:
- 运行报表服务单元测试，验证代码质量
- 初始化数据库表结构
- 测试报表服务各种功能（月度、日报表、周报表、季度报表生成）
- 测试分类筛选功能和自定义字段格式化
- 测试 CLI 命令的各种报表生成选项

**使用方法**:
```bash
./scripts/run_integration_tests.sh
```

**注意事项**:
- 脚本使用 `set -e`，任何测试失败将立即终止执行
- 需要确保数据库连接正常
- 测试过程中会初始化数据库，可能影响现有数据
- 建议在测试环境或备份后运行此脚本

### 2. setup_transaction_test_data.sh - 交易测试数据添加

**用途**: 向 CashLog 数据库添加测试交易数据，用于测试和演示交易管理功能。

**主要功能**:
- 添加当前月份（12月）的收入数据：工资、奖金
- 添加当前月份的支出数据：餐饮、购物、交通、房租等
- 添加上个月份（11月）的历史数据，用于环比计算
- 提供查看数据的命令示例

**使用方法**:
```bash
./scripts/setup_transaction_test_data.sh
```

**注意事项**:
- 执行前请确保数据库已初始化
- 重复执行会添加重复数据，建议清理后重新添加

### 3. setup_todo_test_data.sh - 待办事项测试数据添加

**用途**: 向 CashLog 数据库添加多样化的测试待办事项数据，用于测试和演示待办事项管理功能。

**主要功能**:
- 添加多种类别的待办事项：工作、个人事务、学习、娱乐等
- 设置不同的状态：待办、进行中、已完成
- 包含不同的标签和截止时间，模拟真实使用场景
- 提供查看数据的命令示例

**使用方法**:
```bash
./scripts/setup_todo_test_data.sh
```

**注意事项**:
- 执行前请确保数据库已初始化
- 重复执行会添加重复数据，建议清理后重新添加

### 4. test_backup_restore_workflow.sh - 备份恢复功能正常流程测试

**用途**: 测试 CashLog 数据备份与恢复功能的正常工作流程，验证系统能够正确创建备份、恢复数据并保持数据完整性。

**主要功能**:
- 初始化数据库并确保系统正常工作
- 添加测试交易数据（收入和支出）
- 创建数据库备份
- 修改数据（添加新交易模拟数据变更）
- 从备份恢复数据
- 验证恢复后的数据完整性

**使用方法**:
```bash
./scripts/test_backup_restore_workflow.sh
```

**注意事项**:
- 脚本会在项目根目录下创建 `tmp_cashlog_backup_test.db` 临时备份文件
- 测试过程中需要人工确认某些步骤
- 测试完成后可选择是否删除临时备份文件

### 5. test_backup_restore_error_cases.sh - 备份恢复功能异常场景测试

**用途**: 测试 CashLog 数据备份与恢复功能在各种异常情况下的行为，验证系统的错误处理能力和健壮性。

**主要功能**:
- 测试使用无效文件（文本文件）恢复数据
- 测试使用假数据库文件（无SQLite头）恢复数据
- 测试备份文件覆盖冲突处理
- 测试无效文件扩展名处理
- 测试恢复不存在的文件

**使用方法**:
```bash
./scripts/test_backup_restore_error_cases.sh
```

**注意事项**:
- 脚本会在项目根目录下创建 `tmp_cashlog_test` 临时目录
- 测试过程中需要人工确认某些步骤
- 测试完成后可选择是否删除临时文件

### 6. test_transaction_todo_association.sh - 交易与待办双向关联功能测试

**用途**: 全面测试 CashLog 系统中交易记录与待办事项之间的双向关联功能，验证关联创建、更新、查询和解除等操作的完整性。

**主要功能**:
- 初始化数据库环境
- 创建测试交易和待办事项数据
- 测试交易与待办的双向关联创建
- 验证关联信息的查询和显示
- 测试关联关系的更新和修改
- 测试关联关系的解除
- 验证边界条件和异常处理

**使用方法**:
```bash
./scripts/test_transaction_todo_association.sh
```

**注意事项**:
- 脚本使用 `set -e`，任何测试失败将立即终止执行
- 测试过程中会删除并重建数据库文件 (`data/cashlog.db`)
- 每个测试步骤后需要按回车键继续
- 最后一步提供3秒时间用于保留测试数据，否则将自动清理

## 测试执行顺序建议

为了全面测试系统功能，建议按以下顺序执行测试脚本：

1. **数据准备**:
   ```bash
   ./scripts/setup_transaction_test_data.sh
   ./scripts/setup_todo_test_data.sh
   ```

2. **功能测试**:
   ```bash
   ./scripts/test_transaction_todo_association.sh
   ./scripts/test_backup_restore_workflow.sh
   ./scripts/test_backup_restore_error_cases.sh
   ```

3. **集成测试**:
   ```bash
   ./scripts/run_integration_tests.sh
   ```

每个脚本都专注于特定功能，可以根据需要单独执行，也可以按上述顺序完整执行所有测试。
- 最后一步提供3秒时间用于保留测试数据，否则将自动清理

## 脚本执行权限

在首次使用脚本前，请确保脚本具有执行权限：

```bash
chmod +x scripts/*.sh
```

## 开发指南

### 添加新脚本

1. 在 `scripts` 目录下创建新的 shell 脚本文件
2. 使用与其他脚本一致的注释格式和结构
3. 确保脚本具有适当的错误处理和用户反馈
4. 更新本 README.md 文件，添加新脚本的说明

### 脚本编写规范

1. 使用 `#!/bin/bash` 或 `#!/bin/zsh` 作为脚本开头
2. 添加详细的注释说明脚本用途、功能和使用方法
3. 使用彩色输出提高用户体验（定义 RED、GREEN、YELLOW、BLUE 等颜色变量）
4. 提供适当的错误处理和退出码
5. 在脚本开头添加 `set -e` 确保遇到错误时立即退出
6. 使用临时文件时，提供清理选项

## 注意事项

1. 所有脚本都应在项目根目录下执行
2. 执行脚本前请确保已安装必要的依赖（Python、uv 等）
3. 部分脚本会修改数据库，请在执行前备份重要数据
4. 测试脚本可能会创建临时文件，请根据提示进行清理
5. 如果遇到权限问题，请使用 `chmod +x` 命令添加执行权限

## 故障排除

### 常见问题

1. **权限被拒绝**: 使用 `chmod +x scripts/脚本名.sh` 添加执行权限
2. **命令未找到**: 确保在项目根目录下执行脚本，并检查 PATH 环境变量
3. **数据库连接失败**: 检查数据库文件是否存在，以及是否有读写权限
4. **Python 模块导入错误**: 确保已使用 `uv sync` 安装所有依赖

### 调试技巧

1. 使用 `bash -x scripts/脚本名.sh` 查看脚本详细执行过程
2. 在脚本中添加 `echo` 语句输出调试信息
3. 检查脚本的退出码 `$?` 确定错误来源

## 贡献指南

如果您想为 Scripts 目录贡献新的脚本或改进现有脚本：

1. 确保新脚本遵循现有的命名和结构规范
2. 添加适当的注释和文档
3. 测试脚本在各种场景下的行为
4. 提交前请更新本 README.md 文件
5. 确保脚本具有适当的执行权限